apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: x86
spec:
  template:
    metadata:
      labels:
        karpenter.sh/capacity-type: on-demand
        node-type: x86
        arch: amd64
    spec:
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: x86

      requirements:
        # 固定实例类型 r7i.8xlarge
        - key: node.kubernetes.io/instance-type
          operator: In
          values: ["r7i.8xlarge"]

        # On-demand 实例
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]

        # 可用区
        - key: topology.kubernetes.io/zone
          operator: In
          values: ["${AWS_REGION}a", "${AWS_REGION}b", "${AWS_REGION}c"]

      # Taints - 确保只有指定的工作负载运行在 x86 节点上
      taints:
        - key: arch
          value: amd64
          effect: NoSchedule

  limits:
    cpu: "1000"
    memory: 1000Gi

  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 1m
    budgets:
      - nodes: "10%"

  weight: 20
