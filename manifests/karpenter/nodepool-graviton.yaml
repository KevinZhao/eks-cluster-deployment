apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: graviton
spec:
  template:
    metadata:
      labels:
        karpenter.sh/capacity-type: on-demand
        node-type: graviton
        arch: arm64
    spec:
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: graviton

      requirements:
        # 固定实例类型 r8g.8xlarge
        - key: node.kubernetes.io/instance-type
          operator: In
          values: ["r8g.8xlarge"]

        # On-demand 实例
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]

        # 可用区
        - key: topology.kubernetes.io/zone
          operator: In
          values: ["${AWS_REGION}a", "${AWS_REGION}b", "${AWS_REGION}c"]

      # Taints - 确保只有指定的工作负载运行在 Graviton 节点上
      taints:
        - key: arch
          value: arm64
          effect: NoSchedule

  limits:
    cpu: "1000"
    memory: 1000Gi

  # 中断处理 - 禁用自动缩容（只扩容不缩容）
  disruption:
    consolidationPolicy: WhenEmpty
    consolidateAfter: 24h
    budgets:
      - nodes: "0%"

  weight: 20
