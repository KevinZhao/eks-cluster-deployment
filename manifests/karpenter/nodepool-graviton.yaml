apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: graviton
spec:
  template:
    metadata:
      labels:
        karpenter.sh/capacity-type: on-demand
        node-type: graviton
        arch: arm64
    spec:
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: graviton

      requirements:
        # 固定实例类型 r8g.8xlarge
        - key: node.kubernetes.io/instance-type
          operator: In
          values: ["r8g.8xlarge"]

        # On-demand 实例
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]

        # 可用区
        - key: topology.kubernetes.io/zone
          operator: In
          values: ["${AWS_REGION}a", "${AWS_REGION}b", "${AWS_REGION}c"]

      # Taints - 移除 taints，使用 nodeSelector 就足够了
      # 如果需要专用节点，请给 Pod 添加对应的 tolerations
      # taints:
      #   - key: arch
      #     value: arm64
      #     effect: NoSchedule

  limits:
    cpu: "1000"
    memory: 1000Gi

  # 中断处理 - 节点空闲1小时后缩容
  disruption:
    consolidationPolicy: WhenEmpty
    consolidateAfter: 1h
    budgets:
      - nodes: "10%"

  weight: 20
