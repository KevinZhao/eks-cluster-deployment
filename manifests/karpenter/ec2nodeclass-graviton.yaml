apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: graviton
spec:
  # AMI 选择器 - 使用 EKS 优化的 AL2023 ARM64 AMI
  amiFamily: AL2023
  amiSelectorTerms:
    - name: "amazon-eks-node-al2023-arm64-standard-1.34-*"

  # IAM 角色
  role: "KarpenterNodeRole-${CLUSTER_NAME}"

  # 子网选择器
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"

  # 安全组选择器
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"

  # 块设备映射
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 50Gi
        volumeType: gp3
        iops: 3000
        throughput: 125
        encrypted: true
        deleteOnTermination: true

    - deviceName: /dev/xvdb
      ebs:
        volumeSize: 100Gi
        volumeType: gp3
        iops: 3000
        throughput: 125
        encrypted: true
        deleteOnTermination: true

  # User Data - 使用 LVM 挂载数据盘到 /var/lib/containerd
  userData: |
    MIME-Version: 1.0
    Content-Type: multipart/mixed; boundary="==BOUNDARY=="

    --==BOUNDARY==
    Content-Type: text/cloud-boothook; charset="us-ascii"

    #!/bin/bash
    # Mount data disk to /var/lib/containerd using LVM
    set -euxo pipefail

    # Stop containerd first
    systemctl stop containerd || true

    # Auto-detect EBS data disk (exclude root disk nvme0n1)
    # Use inline detection to avoid variable expansion issues
    if [ -z "\$(lsblk -dpno NAME | grep nvme | grep -v nvme0n1 | head -1)" ]; then
      echo "No data disk found, skip LVM setup"
      systemctl start containerd
      exit 0
    fi

    # Check if LVM already configured
    if vgs vg_data &>/dev/null; then
      echo "LVM already configured"
    else
      # Install lvm2 (not installed by default on AL2023)
      dnf install -y lvm2

      # Create LVM using inline disk detection
      pvcreate "\$(lsblk -dpno NAME | grep nvme | grep -v nvme0n1 | head -1)"
      vgcreate vg_data "\$(lsblk -dpno NAME | grep nvme | grep -v nvme0n1 | head -1)"
      lvcreate -l 100%VG -n lv_containerd vg_data
      mkfs.xfs /dev/vg_data/lv_containerd
    fi

    # Mount containerd
    mkdir -p /var/lib/containerd
    rm -rf /var/lib/containerd/*
    mount /dev/vg_data/lv_containerd /var/lib/containerd
    grep -q "lv_containerd" /etc/fstab || \
      echo "/dev/vg_data/lv_containerd /var/lib/containerd xfs defaults,nofail 0 2" >> /etc/fstab

    systemctl start containerd

    --==BOUNDARY==--

  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 1
    httpTokens: required

  tags:
    Environment: production
    ManagedBy: karpenter
    Architecture: arm64
    karpenter.sh/discovery: "${CLUSTER_NAME}"
