apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: ${CLUSTER_NAME}
  region: ${AWS_DEFAULT_REGION}
  version: "${K8S_VERSION}"
  tags:
    cluster-autoscaler: enabled

# Kubernetes 网络配置
kubernetesNetworkConfig:
  serviceIPv4CIDR: "${SERVICE_IPV4_CIDR}"

# 使用已经存在的vpc
vpc:
  id: "${VPC_ID}"
  subnets:
    private:
      ${AZ_A}:
        id: "${PRIVATE_SUBNET_A}"
      ${AZ_B}:
        id: "${PRIVATE_SUBNET_B}"
      ${AZ_C}:
        id: "${PRIVATE_SUBNET_C}"
    public:
      ${AZ_A}:
        id: "${PUBLIC_SUBNET_A}"
      ${AZ_B}:
        id: "${PUBLIC_SUBNET_B}"
      ${AZ_C}:
        id: "${PUBLIC_SUBNET_C}"
  clusterEndpoints:
    privateAccess: true
    publicAccess: false

accessConfig:
  authenticationMode: API_AND_CONFIG_MAP

# IAM 配置 - 使用 Pod Identity
iam:
  withOIDC: false

# 节点组配置
# 系统节点组，主要运行aws-load-balancer-controller coredns cluster-autoscaler等组件
managedNodeGroups:
  - name: eks-utils
    instanceType: m7i.large
    amiFamily: AmazonLinux2023
    desiredCapacity: 3
    minSize: 3
    maxSize: 6
    volumeSize: 30
    volumeType: gp3
    # Additional data disk for containerd
    additionalVolumes:
      - volumeName: "/dev/sdz"
        volumeSize: 100
        volumeType: gp3
    # Mount data disk to /var/lib/containerd before EKS bootstrap
    preBootstrapCommands:
      - |
        set -euxo pipefail
        systemctl stop containerd || true

        # Auto-detect EBS data disk (exclude instance store)
        DEVICE=$(nvme list 2>/dev/null | grep 'Amazon Elastic Block Store' | tail -n 1 | awk '{print $1}')
        if [ -z "$DEVICE" ]; then
          DEVICE=$(lsblk -dpno NAME,MOUNTPOINT | awk '$2==""{print $1}' | grep nvme | tail -n 1)
        fi

        if [ -n "$DEVICE" ]; then
          blkid "$DEVICE" || mkfs -t ext4 "$DEVICE"
          mkdir -p /var/lib/containerd
          rm -rf /var/lib/containerd/*
          mount "$DEVICE" /var/lib/containerd
          grep -q "/var/lib/containerd" /etc/fstab || \
            echo "$DEVICE /var/lib/containerd ext4 defaults,nofail 0 2" >> /etc/fstab
        fi

        systemctl start containerd
    privateNetworking: true
    subnets:
      - ${PRIVATE_SUBNET_A}
      - ${PRIVATE_SUBNET_B}
      - ${PRIVATE_SUBNET_C}
    labels:
      app: "eks-utils"
      arch: "amd64"
    tags:
      k8s.io/cluster-autoscaler/enabled: "true"
      k8s.io/cluster-autoscaler/${CLUSTER_NAME}: "owned"

  - name: app
    instanceType: c8g.large
    amiFamily: AmazonLinux2023
    desiredCapacity: 3
    minSize: 3
    maxSize: 12
    volumeSize: 30
    volumeType: gp3
    # Additional data disk for containerd
    additionalVolumes:
      - volumeName: "/dev/sdz"
        volumeSize: 100
        volumeType: gp3
    # Mount data disk to /var/lib/containerd before EKS bootstrap
    preBootstrapCommands:
      - |
        set -euxo pipefail
        systemctl stop containerd || true

        # Auto-detect EBS data disk (exclude instance store)
        DEVICE=$(nvme list 2>/dev/null | grep 'Amazon Elastic Block Store' | tail -n 1 | awk '{print $1}')
        if [ -z "$DEVICE" ]; then
          DEVICE=$(lsblk -dpno NAME,MOUNTPOINT | awk '$2==""{print $1}' | grep nvme | tail -n 1)
        fi

        if [ -n "$DEVICE" ]; then
          blkid "$DEVICE" || mkfs -t ext4 "$DEVICE"
          mkdir -p /var/lib/containerd
          rm -rf /var/lib/containerd/*
          mount "$DEVICE" /var/lib/containerd
          grep -q "/var/lib/containerd" /etc/fstab || \
            echo "$DEVICE /var/lib/containerd ext4 defaults,nofail 0 2" >> /etc/fstab
        fi

        systemctl start containerd
    privateNetworking: true
    subnets:
      - ${PRIVATE_SUBNET_A}
      - ${PRIVATE_SUBNET_B}
      - ${PRIVATE_SUBNET_C}
    labels:
      app: application
      arch: "arm64"
      workload: "user-apps"
    taints:
      - key: "workload"
        value: "user-apps"
        effect: "NoSchedule"
    tags:
      k8s.io/cluster-autoscaler/enabled: "true"
      k8s.io/cluster-autoscaler/${CLUSTER_NAME}: "owned"

addons:
  - name: vpc-cni
    version: latest
  - name: coredns
    version: latest
    configurationValues: |
      nodeSelector:
        app: eks-utils
  - name: kube-proxy
    version: latest
  - name: eks-pod-identity-agent
    version: latest
  - name: aws-ebs-csi-driver
    version: latest

cloudWatch:
  clusterLogging:
    logRetentionInDays: 30
    enableTypes:
      - "api"
      - "audit"
      - "authenticator"
      - "controllerManager"
      - "scheduler"
